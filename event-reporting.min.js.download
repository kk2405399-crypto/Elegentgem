"use strict";var EventReporting=(()=>{var v=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames,m=Object.getOwnPropertySymbols;var k=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var b=(i,e,t)=>e in i?v(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,l=(i,e)=>{for(var t in e||(e={}))k.call(e,t)&&b(i,t,e[t]);if(m)for(var t of m(e))B.call(e,t)&&b(i,t,e[t]);return i};var R=(i,e)=>{for(var t in e)v(i,t,{get:e[t],enumerable:!0})},x=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of A(e))!k.call(i,o)&&o!==t&&v(i,o,{get:()=>e[o],enumerable:!(n=E(e,o))||n.enumerable});return i};var C=i=>x(v({},"__esModule",{value:!0}),i);var f=(i,e,t)=>new Promise((n,o)=>{var h=r=>{try{d(t.next(r))}catch(g){o(g)}},a=r=>{try{d(t.throw(r))}catch(g){o(g)}},d=r=>r.done?n(r.value):Promise.resolve(r.value).then(h,a);d((t=t.apply(i,e)).next())});var j={};R(j,{EventReporting:()=>c,default:()=>F,destroyEventReporting:()=>L,getDeviceId:()=>p,getEventReporting:()=>T,getSessionId:()=>u,initEventReporting:()=>P,isBot:()=>y});function y(){return typeof navigator=="undefined"?!0:navigator.userAgent.toLowerCase().includes("bot")}function D(){let i=Date.now(),e=Math.random().toString(36).substring(2,15);return`device_${i}_${e}`}function S(){let i=Date.now(),e=Math.random().toString(36).substring(2,15);return`session_${i}_${e}`}function p(i){try{let e=localStorage.getItem(i);if(!e){e=D();try{localStorage.setItem(i,e)}catch(t){try{sessionStorage.setItem(i,e)}catch(n){window.__event_reporting_device_id=e}}}return e}catch(e){if(window.__event_reporting_device_id)return window.__event_reporting_device_id;let t=D();return window.__event_reporting_device_id=t,t}}function u(i){try{let e=sessionStorage.getItem(i);if(!e){e=S();try{sessionStorage.setItem(i,e)}catch(t){window.__event_reporting_session_id=e}}return e}catch(e){if(window.__event_reporting_session_id)return window.__event_reporting_session_id;let t=S();return window.__event_reporting_session_id=t,t}}var I=class{constructor(e){this.enabled=e}log(...e){this.enabled&&console.log("[Event Reporting]",...e)}warn(...e){this.enabled&&console.warn("[Event Reporting]",...e)}error(...e){this.enabled&&console.error("[Event Reporting]",...e)}};var K={domain:typeof window!="undefined"?window.location.origin:"",apiEndpoint:"/api/analysis/event/report",enabled:!0,debug:!1,autoInit:!0,projectId:null,deviceIdKey:"readdy_device_id",sessionIdKey:"readdy_session_id",timeout:3e3,extractProjectId:()=>{let e=window.location.pathname.split("/").filter(n=>n),t=e.indexOf("preview");return t!==-1&&e.length>t+1?e[t+1]:null}},c=class{constructor(e){this.observer=null;this.deviceIdBackup=null;this.sessionIdBackup=null;this.isFirstPageView=!0;this.config=l(l({},K),e),this.logger=new I(this.config.debug)}init(){if(!this.config.enabled){this.logger.log("Analytics is disabled");return}this.logger.log("Initializing analytics..."),this.backupIds(),this.trackPageView(),this.setupRouteListener(),this.setupStorageListener()}backupIds(){try{this.deviceIdBackup=p(this.config.deviceIdKey),this.logger.log("Device ID backed up:",this.deviceIdBackup),this.sessionIdBackup=u(this.config.sessionIdKey),this.logger.log("Session ID backed up:",this.sessionIdBackup)}catch(e){this.logger.error("Failed to backup IDs:",e)}}setupRouteListener(){if(typeof window=="undefined")return;let e=history.pushState,t=history.replaceState;history.pushState=function(...n){e.apply(this,n),window.dispatchEvent(new Event("locationchange"))},history.replaceState=function(...n){t.apply(this,n),window.dispatchEvent(new Event("locationchange"))},window.addEventListener("popstate",()=>{window.dispatchEvent(new Event("locationchange"))}),window.addEventListener("locationchange",()=>{this.trackPageView()}),this.logger.log("Route listener setup complete")}setupStorageListener(){typeof window!="undefined"&&(window.addEventListener("storage",e=>{if(e.key===this.config.deviceIdKey&&e.newValue===null&&(this.logger.log("Device ID was cleared by another tab, restoring..."),this.deviceIdBackup))try{localStorage.setItem(this.config.deviceIdKey,this.deviceIdBackup),this.logger.log("Device ID restored:",this.deviceIdBackup)}catch(t){this.logger.error("Failed to restore device ID:",t)}if(e.key===this.config.sessionIdKey&&e.newValue===null&&(this.logger.log("Session ID was cleared by another tab, restoring..."),this.sessionIdBackup))try{sessionStorage.setItem(this.config.sessionIdKey,this.sessionIdBackup),this.logger.log("Session ID restored:",this.sessionIdBackup)}catch(t){this.logger.error("Failed to restore session ID:",t)}}),setInterval(()=>{try{!localStorage.getItem(this.config.deviceIdKey)&&this.deviceIdBackup&&(this.logger.log("Device ID missing in current tab, restoring..."),localStorage.setItem(this.config.deviceIdKey,this.deviceIdBackup),this.logger.log("Device ID restored:",this.deviceIdBackup))}catch(e){}try{!sessionStorage.getItem(this.config.sessionIdKey)&&this.sessionIdBackup&&(this.logger.log("Session ID missing in current tab, restoring..."),sessionStorage.setItem(this.config.sessionIdKey,this.sessionIdBackup),this.logger.log("Session ID restored:",this.sessionIdBackup))}catch(e){}},5e3),this.logger.log("Storage listener setup complete"))}trackPageView(){return f(this,null,function*(){if(y()){this.logger.log("Bot detected, skipping tracking");return}let e=this.isFirstPageView?"page_view":"page_change";this.logger.log(`Tracking ${e}...`);let t=p(this.config.deviceIdKey),n=u(this.config.sessionIdKey);this.deviceIdBackup=t,this.sessionIdBackup=n;let o=this.config.projectId||this.config.extractProjectId()||null,h=window.location.pathname||"/",a=window.location.href,d=document.referrer||"",r={eventType:e,deviceId:t,sessionId:n,projectId:o,page:h,url:a,referer:d,clientCreateTime:Date.now()};this.logger.log("Tracking data:",r),yield this.sendData(r),this.isFirstPageView&&(this.isFirstPageView=!1,this.logger.log("First page view tracked, subsequent views will be 'page_change'"))})}trackEvent(e){return f(this,null,function*(){this.logger.warn("trackEvent is deprecated and will not send data")})}sendData(e){return f(this,null,function*(){try{let n=(this.config.domain||"https://readdy.ai")+this.config.apiEndpoint,o=yield fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(t){this.logger.error("Analytics tracking error:",t)}})}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.logger.log("Analytics destroyed")}};var s=null;function P(i){return s?(console.warn("Event Reporting already initialized, returning existing instance"),s):(s=new c(i),s.init(),i!=null&&i.debug&&(window.__eventReporting=s),s)}function T(){return s}function L(){s&&(s.destroy(),s=null,window.__eventReporting&&delete window.__eventReporting)}typeof window!="undefined"&&(()=>{if(s)return;let e=window.EventReportingConfig,t=document.currentScript,n={};if(t){let a=t.getAttribute("data-domain"),d=t.getAttribute("data-api-endpoint"),r=t.getAttribute("data-debug"),g=t.getAttribute("data-project-id"),w=t.getAttribute("data-device-id-key"),_=t.getAttribute("data-session-id-key");a&&(n.domain=a),d&&(n.apiEndpoint=d),r&&(n.debug=r==="true"),g&&(n.projectId=g),w&&(n.deviceIdKey=w),_&&(n.sessionIdKey=_)}let o=l(l({},e),n);if(!(o.autoInit===!1||(t==null?void 0:t.getAttribute("data-auto-init"))==="false"))try{s=new c(o),s.init(),window.__eventReporting=s,o.debug&&console.log("[Event Reporting] Auto-initialized with config:",o)}catch(a){console.error("[Event Reporting] Auto-initialization failed:",a)}})();var F=c;return C(j);})();
